{% extends 'layout/templates.html' %}

{% block titulo %}Detalle del Dispositivo - {{ hostname }}{% endblock %}

{% block contenido %}
<header class="dashboard-header">
    Detalle del Dispositivo: {{ hostname }}
</header>

<main class="dashboard-main">
    <div class="titulo-con-riesgo">
        <h2 class="titulo-central">Monitoreo Gráfico en Tiempo Real</h2>
        <div id="riskIndicator" class="indicador-riesgo">Riesgo: N/A</div>
        <a href="{{ url_for('dashboard.index') }}" class="boton-retroceso">
            Listado de Servidores
        </a>
    </div>

    <div class="contenedor-graficos">
        
        <div class="grafico-contenedor lineal">
            <h3>Uso de CPU</h3>
            <canvas id="cpuChart"></canvas>
            <div class="info-adicional-grafico">
                <h4>Procesador (CPU)</h4>
                <div class="info-group">
                    <p><strong>Nombre:</strong> {{ hardware_info_display.Processor.Name }}</p>
                    <p><strong>Fabricante:</strong> {{ hardware_info_display.Processor.Manufacturer }}</p>
                    <p><strong>Descripción:</strong> {{ hardware_info_display.Processor.Description }}</p>
                    <p><strong>Núcleos:</strong> {{ hardware_info_display.Processor.NumberOfCores }}</p>
                    <p><strong>Hilos:</strong> {{ hardware_info_display.Processor.NumberOfLogicalProcessors }}</p>
                    <p><strong>Arquitectura:</strong> {{ hardware_info_display.Processor.Architecture }}</p>
                    <p><strong>ID de Procesador:</strong> {{ hardware_info_display.Processor.ProcessorId }}</p>
                    <p><strong>Velocidad Base (MHz):</strong> {{ hardware_info_display.Processor.MaxClockSpeed_MHz }}</p>
                    <p><strong>Velocidad Actual (MHz):</strong> {{ hardware_info_display.Processor.CurrentClockSpeed_MHz }}</p>
                    <p><strong>Familia/Modelo/Stepping:</strong> {{ hardware_info_display.Processor.Family }}.{{ hardware_info_display.Processor.Model }}.{{ hardware_info_display.Processor.Stepping }}</p>
                    <p><strong>Instrucciones:</strong> {{ hardware_info_display.Processor.Instructions }}</p>
                </div>
                <h5>Caché</h5>
                <div class="info-group">
                    {% for cache in hardware_info_display.Processor.CacheDetails %}
                        <p>{{ cache }}</p>
                    {% else %}
                        <p>No se pudo obtener información detallada de la caché.</p>
                    {% endfor %}
                    <p><strong>L2 Caché:</strong> {{ hardware_info_display.Processor.L2CacheSize_KB }} KB</p>
                    <p><strong>L3 Caché:</strong> {{ hardware_info_display.Processor.L3CacheSize_KB }} KB</p>
                </div>
            </div>
            <a href="{{ url_for('dispositivo.detalle_hardware_cpu', hostname=hostname) }}" class="boton-detalle-grafico">
                Detalle CPU
            </a>
        </div>

        <div class="grafico-contenedor circular">
            <h3>Memoria (%)</h3>
            <canvas id="memoryChart"></canvas>
            <div class="info-adicional-grafico">
                <h4>Memoria</h4>
                <div class="info-group">
                    <p><strong>Total Instalada:</strong> {{ hardware_info_display.Memory.Total_Installed_GB }} GB</p>
                    <p><strong>Módulos Usados:</strong> {{ hardware_info_display.Memory.Number_of_Memory_Modules }}</p>
                    <p><strong>Tipo (Estimado):</strong> {{ hardware_info_display.Memory.Type }}</p>
                </div>
                <h5>Detalle de Módulos</h5>
                <div class="info-group">
                    {% for module in hardware_info_display.Memory.Details %}
                        <p><strong>Slot {{ module.Slot }}:</strong> {{ module.Capacity_GB }} GB ({{ module.Speed_MHz }} MHz) - {{ module.Manufacturer }} (PN: {{ module.Part_Number }})</p>
                    {% else %}
                        <p>No se pudo obtener detalle de módulos RAM.</p>
                    {% endfor %}
                </div>
            </div>
            <button class="boton-detalle-grafico" onclick="irDetalleMemoria('{{ hostname }}')">
                Detalle
            </button>
        </div>

        <div class="grafico-contenedor circular">
            <h3>Disco (%) - Particiones</h3>
            <canvas id="diskChart"></canvas>
            <div class="info-adicional-grafico">
                <h4>Almacenamiento (Discos)</h4>
                <div class="info-group">
                    {% for disk in hardware_info_display.Disks %}
                        <p><strong>Modelo:</strong> {{ disk.Model }}</p>
                        <p><strong>Número de Serie:</strong> {{ disk.SerialNumber }}</p>
                        <p><strong>Capacidad:</strong> {{ disk.Size_GB }} GB</p>
                        <p><strong>Interfaz:</strong> {{ disk.InterfaceType }}</p>
                        {% if not loop.last %}<hr>{% endif %}
                    {% else %}
                        <p>No se encontró información de unidades de disco.</p>
                    {% endfor %}
                </div>
            </div>
            <button class="boton-detalle-grafico" onclick="irDetalleDisco('{{ hostname }}')">
                Detalle
            </button>
        </div>

        <div class="grafico-contenedor lineal">
            <h3>Bytes Tx / Rx (MB)</h3>
            <canvas id="txRxChart"></canvas>
            <div class="info-adicional-grafico">
                <h4>Gráficos (GPU)</h4>
                <div class="info-group">
                    {% for gpu in hardware_info_display.Graphics %}
                        <p><strong>Nombre:</strong> {{ gpu.Name }}</p>
                        <p><strong>Fabricante:</strong> {{ gpu.Manufacturer }}</p>
                        <p><strong>Versión del Driver:</strong> {{ gpu.Driver_Version }}</p>
                        <p><strong>VRAM:</strong> {{ gpu.VRAM_MB }} MB</p>
                        <p><strong>Resolución Actual:</strong> {{ gpu.Resolution }}</p>
                        {% if not loop.last %}<hr>{% endif %}
                    {% else %}
                        <p>No se encontró información de tarjetas gráficas.</p>
                    {% endfor %}
                </div>
            </div>
            <button class="boton-detalle-grafico" onclick="irDetalleRed('{{ hostname }}')">
                Detalle
            </button>
        </div>

    </div>
</main>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
let cpuChartInstance = null;
let memoryChartInstance = null;
let diskChartInstance = null;
let txRxChartInstance = null;

document.addEventListener('DOMContentLoaded', () => {
    const hostname = "{{ hostname }}";

    function actualizarDetalle() {
        fetch(`/get_device_data/${hostname}`)
            .then(response => response.json())
            .then(data => {
                renderCharts(data);
                mostrarRiesgo(data);
            })
            .catch(err => console.error('Error:', err));
    }

    actualizarDetalle();
    setInterval(actualizarDetalle, 5000);
});

function renderCharts(data) {
    const labels = data.timestamps.map(ts => {
        // Asumiendo que ts ya es un string de tiempo formateado, no un timestamp UNIX.
        // Si 'timestamps' en 'data' son strings como "HH:MM:SS", esto no necesita cambio.
        // Si 'timestamps' aún son UNIX timestamps, necesitas convertir de nuevo:
        // const date = new Date(ts * 1000);
        // return date.toLocaleTimeString();
        return ts; // Si ya vienen formateados
    });

    if (cpuChartInstance) cpuChartInstance.destroy();
    if (memoryChartInstance) memoryChartInstance.destroy();
    if (diskChartInstance) diskChartInstance.destroy();
    if (txRxChartInstance) txRxChartInstance.destroy();

    // CPU
    const promedioCpu = data.cpu.length > 0 ? (data.cpu.reduce((sum, val) => sum + val, 0) / data.cpu.length).toFixed(1) : 'N/A';

    cpuChartInstance = new Chart(document.getElementById('cpuChart'), {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: `CPU (%) - Promedio: ${promedioCpu}%`,
                data: data.cpu,
                borderColor: '#00bcd4',
                backgroundColor: '#00bcd4',
                fill: false,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, suggestedMax: 100, ticks: { stepSize: 10 }, grid: { color: '#4a5568' }, fontColor: 'white' }, // Añadir fontColor
                x: { grid: { color: '#4a5568' }, fontColor: 'white' } // Añadir fontColor
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        padding: 20,
                        color: 'white'
                    }
                },
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    offset: 4,
                    color: 'black',
                    font: { size: 10, weight: 'normal' },
                    rotation: 0,
                    formatter: value => value.toFixed(1) + ' %'
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // Memoria
    const memoriaUso = data.memory.length > 0 ? data.memory[data.memory.length - 1] : 0;
    memoryChartInstance = new Chart(document.getElementById('memoryChart'), {
        type: 'doughnut',
        data: {
            labels: ['Usado (%)', 'Libre (%)'],
            datasets: [{ data: [memoriaUso, 100 - memoriaUso], backgroundColor: ['#ffee58', '#4a5568'] }]
        },
        options: {
            cutout: '70%',
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        padding: 20,
                        color: 'white'
                    }
                },
                datalabels: {
                    formatter: (value, ctx) => `${value.toFixed(1)}%`,
                    color: function(ctx) {
                        return ctx.dataIndex === 0 ? 'black' : 'white';
                    },
                    font: { weight: 'normal', size: 12 }
                }
            }
        },
        plugins: [ChartDataLabels]
    });

// ===== Disco - Particiones (Usado y Libre con GB sobre las barras y porcentajes en la leyenda ordenados) =====

// 1. Obtener datos de particiones
const particiones = data.disks || {};
const particionesLabels = Object.keys(particiones);
const particionesUsado = Object.values(particiones);
const particionesLibre = particionesUsado.map(uso => 100 - uso);

const particionesTotalGb = data.disks_total_gb || {};
const particionesUsadoGb = data.disks_used_gb || {};

// 2. Solo los nombres al pie, en el mismo orden
const etiquetas = particionesLabels;

// 3. Construir leyenda dinámica en el mismo orden que las barras
let leyendaUsado = 'Usado (';
let leyendaLibre = 'Libre (';

etiquetas.forEach(label => {
    const porcentajeUsado = particiones[label] || 0;
    const porcentajeLibre = 100 - porcentajeUsado;
    leyendaUsado += `${label}: ${porcentajeUsado.toFixed(1)}% | `;
    leyendaLibre += `${label}: ${porcentajeLibre.toFixed(1)}% | `;
});

// Eliminar el último separador " | " y cerrar paréntesis
leyendaUsado = leyendaUsado.slice(0, -3) + ')';
leyendaLibre = leyendaLibre.slice(0, -3) + ')';

// 4. Render del gráfico
diskChartInstance = new Chart(document.getElementById('diskChart'), {
    type: 'bar',
    data: {
        labels: etiquetas,
        datasets: [
            {
                label: leyendaUsado,
                data: particionesUsado,
                backgroundColor: '#7b1fa2',
                datalabels: {
                    color: 'white',
                    font: { size: 10, weight: 'bold' },
                    anchor: 'center',
                    align: 'center',
                    offset: 0,
                    formatter: (value, ctx) => {
                        const label = particionesLabels[ctx.dataIndex];
                        const usadoGb = particionesUsadoGb[label] || 0;
                        return `${usadoGb.toFixed(1)} GB`;
                    }
                }
            },
            {
                label: leyendaLibre,
                data: particionesLibre,
                backgroundColor: '#4a5568',
                datalabels: {
                    color: 'white',
                    font: { size: 10, weight: 'bold' },
                    anchor: 'center',
                    align: 'center',
                    offset: 0,
                    formatter: (value, ctx) => {
                        const label = particionesLabels[ctx.dataIndex];
                        const totalGb = particionesTotalGb[label] || 0;
                        const usadoGb = particionesUsadoGb[label] || 0;
                        const libreGb = (totalGb - usadoGb).toFixed(1);
                        return `${libreGb} GB`;
                    }
                }
            }
        ]
    },
    options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, suggestedMax: 100, ticks: { stepSize: 10 }, grid: { color: '#4a5568' }, stacked: true,
                     // Añadir color de fuente para el eje Y
                     ticks: { color: 'white' }
                },
                x: { grid: { color: '#4a5568' }, stacked: true,
                     // Añadir color de fuente para el eje X
                     ticks: { color: 'white' }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        padding: 20,
                        color: 'white'
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });


    // Tx/Rx
    txRxChartInstance = new Chart(document.getElementById('txRxChart'), {
        type: 'bar',
        data: {
            labels,
            datasets: [
                {
                    label: 'Bytes Tx (MB)',
                    data: data.tx,
                    backgroundColor: '#69f0ae',
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        offset: 4,
                        color: '#000',
                        font: { size: 10 },
                        rotation: -90,
                        formatter: value => value.toFixed(2) + ' MB'
                    }
                },
                {
                    label: 'Bytes Rx (MB)',
                    data: data.rx,
                    backgroundColor: '#ff5252',
                    datalabels: {
                        anchor: 'end',
                        align: 'start',
                        offset: -4,
                        color: '#000',
                        font: { size: 10 },
                        rotation: -90,
                        formatter: value => value.toFixed(2) + ' MB'
                    }
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: calcularStepSize(data.tx, data.rx) }, grid: { color: '#4a5568' } },
                x: { grid: { color: '#4a5568' } }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        padding: 20,
                        color: 'white'
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
}

function mostrarRiesgo(data) {
    const riskIndicator = document.getElementById('riskIndicator');
    if (!riskIndicator) return;

    if (data.riesgo === undefined || data.riesgo === null) {
        riskIndicator.textContent = "Riesgo: N/A";
        riskIndicator.style.backgroundColor = "#4a5568";
    } else {
        if (data.riesgo < 40) {
            riskIndicator.style.backgroundColor = "var(--success-color)";
            riskIndicator.textContent = `Riesgo: Bajo (${data.riesgo.toFixed(1)}%)`;
        } else if (data.riesgo < 70) {
            riskIndicator.style.backgroundColor = "var(--warning-color)";
            riskIndicator.textContent = `Riesgo: Medio (${data.riesgo.toFixed(1)}%)`;
        } else {
            riskIndicator.style.backgroundColor = "var(--danger-color)";
            riskIndicator.textContent = `Riesgo: Alto (${data.riesgo.toFixed(1)}%)`;
        }
    }
}

function calcularStepSize(tx, rx) {
    const maxValor = Math.max(...tx, ...rx);
    if (maxValor <= 10) return 1;
    if (maxValor <= 50) return 5;
    if (maxValor <= 100) return 10;
    if (maxValor <= 500) return 50;
    if (maxValor <= 1000) return 100;
    return Math.ceil(maxValor / 10);
}
</script>
{% endblock %}